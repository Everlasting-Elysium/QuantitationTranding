# æ¨èåŠŸèƒ½ä¿®å¤æ€»ç»“ / Recommendation Feature Fix Summary
**æ—¥æœŸ / Date**: 2024-12-08

## é—®é¢˜æè¿° / Problem Description

### ç”¨æˆ·æŠ¥å‘Šçš„é—®é¢˜
1. **æ¨èè‚¡ç¥¨å›ºå®š** - æ¯æ¬¡éƒ½æ¨èç›¸åŒçš„5åªè‚¡ç¥¨ï¼ˆè´µå·èŒ…å°ã€å®å¾·æ—¶ä»£ã€æ¯”äºšè¿ªã€äº”ç²®æ¶²ã€ä¸­å›½å¹³å®‰ï¼‰
2. **æ•°æ®æ¥æºç–‘é—®** - ä¸ç¡®å®šæ¨èæ˜¯åŸºäºä»€ä¹ˆæ•°æ®

## æ ¹æœ¬åŸå› åˆ†æ / Root Cause Analysis

### 1. ç¡¬ç¼–ç çš„æ¨¡æ‹Ÿæ¨è

**ä½ç½®**: `src/cli/guided_workflow.py` ç¬¬305-311è¡Œï¼ˆä¿®æ”¹å‰ï¼‰

**é—®é¢˜ä»£ç **:
```python
# Mock recommendations (in real implementation, call PerformanceAnalyzer)
mock_recommendations = [
    {"symbol": "600519", "name": "è´µå·èŒ…å°", ...},
    {"symbol": "300750", "name": "å®å¾·æ—¶ä»£", ...},
    {"symbol": "002594", "name": "æ¯”äºšè¿ª", ...},
    {"symbol": "000858", "name": "äº”ç²®æ¶²", ...},
    {"symbol": "601318", "name": "ä¸­å›½å¹³å®‰", ...},
]
```

**åŸå› **:
- ä½¿ç”¨ç¡¬ç¼–ç çš„æ¨¡æ‹Ÿæ•°æ®
- æ³¨é‡Šä¸­è¯´æ˜"å®é™…å®ç°ä¸­è°ƒç”¨PerformanceAnalyzer"ï¼Œä½†æœªå®ç°
- æ¯æ¬¡è¿è¡Œè¿”å›ç›¸åŒçš„5åªè‚¡ç¥¨å’Œå›ºå®šçš„æ”¶ç›Šç‡

### 2. æ•°æ®æ—¶æ•ˆæ€§é—®é¢˜

**æ•°æ®ä¿¡æ¯**:
- æ•°æ®è·¯å¾„: `~/.qlib/qlib_data/cn_data/`
- æ•°æ®èŒƒå›´: 1999-11-10 åˆ° 2020-09-25
- æ•°æ®ç±»å‹: å†å²æ•°æ®ï¼ˆéå®æ—¶ï¼‰
- è‚¡ç¥¨æ•°é‡: 3874åª

**é™åˆ¶**:
- æ•°æ®æˆªæ­¢åˆ°2020å¹´9æœˆ
- ä¸åŒ…å«æœ€è¿‘4å¹´çš„æ•°æ®
- æ— æ³•åæ˜ æœ€æ–°å¸‚åœºæƒ…å†µ

## è§£å†³æ–¹æ¡ˆ / Solution

### å®æ–½çš„ä¿®æ”¹

#### 1. æ·»åŠ å¿…è¦çš„å¯¼å…¥

**æ–‡ä»¶**: `src/cli/guided_workflow.py`

**ä¿®æ”¹**:
```python
# æ·»åŠ å¯¼å…¥
from ..application.performance_analyzer import PerformanceAnalyzer
from ..infrastructure.qlib_wrapper import QlibWrapper
```

#### 2. æ›¿æ¢ç¡¬ç¼–ç æ¨èä¸ºçœŸå®åˆ†æ

**ä¿®æ”¹å‰**:
```python
# Mock recommendations
mock_recommendations = [...]
self.state.recommended_assets = mock_recommendations
```

**ä¿®æ”¹å**:
```python
# ä½¿ç”¨çœŸå®çš„æ€§èƒ½åˆ†æå™¨
recommendations = []
try:
    # åˆå§‹åŒ–qlibå’Œæ€§èƒ½åˆ†æå™¨
    qlib_wrapper = QlibWrapper()
    data_path = Path.home() / ".qlib" / "qlib_data" / "cn_data"
    qlib_wrapper.init(provider_uri=str(data_path), region="cn")
    analyzer = PerformanceAnalyzer(qlib_wrapper)
    
    # åˆ†æå†å²è¡¨ç°
    report = analyzer.analyze_historical_performance(
        market=self.state.market or "CN",
        asset_type=self.state.asset_type or "stock",
        lookback_years=3,
        instruments="csi300"
    )
    
    # è½¬æ¢æ¨èæ ¼å¼
    for asset in report.top_performers[:10]:
        recommendations.append({
            "symbol": asset.symbol,
            "name": asset.name or asset.symbol,
            "annual_return": asset.annual_return * 100,
            "sharpe_ratio": asset.sharpe_ratio,
            "max_drawdown": asset.max_drawdown * 100
        })
        
except Exception as e:
    # åå¤‡æ–¹æ¡ˆï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    recommendations = [...]  # åŸæ¥çš„ç¡¬ç¼–ç æ•°æ®

self.state.recommended_assets = recommendations
```

#### 3. ä¿®å¤å˜é‡å¼•ç”¨é”™è¯¯

**é—®é¢˜**: æ˜¾ç¤ºå’Œé€‰æ‹©éƒ¨åˆ†ä»åœ¨ä½¿ç”¨ `mock_recommendations` å˜é‡

**ä¿®æ”¹**:
- å°†æ‰€æœ‰ `mock_recommendations` æ”¹ä¸º `recommendations`
- æ·»åŠ æ ¼å¼åŒ–è¾“å‡ºï¼ˆ`.2f`ï¼‰

#### 4. å®‰è£…ç¼ºå¤±çš„ä¾èµ–

```bash
pip install scipy
```

## ä¿®æ”¹çš„æ–‡ä»¶ / Modified Files

1. **src/cli/guided_workflow.py**
   - æ·»åŠ å¯¼å…¥: `PerformanceAnalyzer`, `QlibWrapper`
   - ä¿®æ”¹ `_step_asset_recommendation` æ–¹æ³•
   - å®ç°çœŸå®æ•°æ®åˆ†æ
   - æ·»åŠ å¼‚å¸¸å¤„ç†å’Œåå¤‡æ–¹æ¡ˆ
   - ä¿®å¤å˜é‡å¼•ç”¨

2. **requirements.txt** (éœ€è¦ç¡®ä¿åŒ…å«)
   - scipy

## åŠŸèƒ½ç‰¹ç‚¹ / Features

### ä¼˜å…ˆä½¿ç”¨çœŸå®æ•°æ® âœ…
- åŸºäºå†å²æ•°æ®çš„çœŸå®åˆ†æ
- ä½¿ç”¨ `PerformanceAnalyzer` è®¡ç®—æŒ‡æ ‡
- æ¨èä¼šæ ¹æ®ä¸åŒå‚æ•°å˜åŒ–

### æ™ºèƒ½åå¤‡æ–¹æ¡ˆ âœ…
- å¦‚æœçœŸå®åˆ†æå¤±è´¥ï¼Œè‡ªåŠ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
- æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯å‘ŠçŸ¥ç”¨æˆ·
- ç¡®ä¿ç³»ç»Ÿå§‹ç»ˆå¯ç”¨

### é”™è¯¯å¤„ç† âœ…
- æ•è·å¹¶å¤„ç†å„ç§å¼‚å¸¸
- æä¾›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- ä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ

## å½“å‰è¡Œä¸º / Current Behavior

ç”±äºæ•°æ®é™åˆ¶ï¼ˆåªåˆ°2020å¹´9æœˆï¼‰ï¼Œå½“å‰è¡Œä¸ºå¦‚ä¸‹ï¼š

1. **å°è¯•çœŸå®åˆ†æ** - ç³»ç»Ÿä¼šå°è¯•ä½¿ç”¨ `PerformanceAnalyzer`
2. **åˆ†æå¤±è´¥** - å› ä¸ºè¦æ±‚åˆ†æ"æœ€è¿‘3å¹´"ï¼ˆ2021-2024ï¼‰ï¼Œè¶…å‡ºæ•°æ®èŒƒå›´
3. **ä½¿ç”¨åå¤‡æ–¹æ¡ˆ** - è‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨è
4. **æ˜¾ç¤ºè­¦å‘Š** - å‘ŠçŸ¥ç”¨æˆ·ä½¿ç”¨äº†æ¨¡æ‹Ÿæ•°æ®

**ç”¨æˆ·çœ‹åˆ°çš„æ•ˆæœ**:
```
âš ï¸  æ— æ³•åˆ†æçœŸå®æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨è
âš ï¸  Cannot analyze real data, using mock recommendations
åŸå›  / Reason: [é”™è¯¯ä¿¡æ¯]
```

## æœªæ¥æ”¹è¿› / Future Improvements

### çŸ­æœŸï¼ˆç«‹å³å¯åšï¼‰

1. **ä¿®æ”¹æ€§èƒ½åˆ†æå™¨æ”¯æŒè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´**
   ```python
   def analyze_historical_performance(
       self,
       market: str,
       asset_type: str,
       start_date: Optional[str] = None,  # æ–°å¢
       end_date: Optional[str] = None,    # æ–°å¢
       lookback_years: int = 3,
       instruments: Optional[str] = None
   ):
       if end_date is None:
           end_date = datetime.now()
       else:
           end_date = datetime.strptime(end_date, "%Y-%m-%d")
       # ...
   ```

2. **ä½¿ç”¨æ•°æ®èŒƒå›´å†…çš„æ—¥æœŸ**
   ```python
   # åœ¨å¼•å¯¼å¼å·¥ä½œæµç¨‹ä¸­
   data_info = qlib_wrapper.get_data_info()
   end_date = data_info['data_end']  # ä½¿ç”¨æ•°æ®çš„å®é™…ç»“æŸæ—¥æœŸ
   ```

### ä¸­æœŸï¼ˆæœ¬å‘¨ï¼‰

1. **æ›´æ–°æ•°æ®åˆ°æœ€æ–°**
   ```bash
   python -m qlib.run.get_data qlib_data \
       --target_dir ~/.qlib/qlib_data/cn_data \
       --region cn
   ```

2. **æ·»åŠ æ•°æ®æ—¶æ•ˆæ€§æ£€æŸ¥**
   - æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸ
   - æç¤ºç”¨æˆ·æ›´æ–°æ•°æ®
   - æ˜¾ç¤ºæ•°æ®çš„å®é™…æ—¶é—´èŒƒå›´

### é•¿æœŸï¼ˆæœ¬æœˆï¼‰

1. **æ¥å…¥å®æ—¶æ•°æ®æº**
   - é›†æˆTushareæˆ–AKShare
   - å®ç°è‡ªåŠ¨æ•°æ®æ›´æ–°
   - æ”¯æŒç›˜ä¸­å®æ—¶åˆ†æ

2. **ä¼˜åŒ–æ¨èç®—æ³•**
   - æ·»åŠ æ›´å¤šè¯„ä¼°æŒ‡æ ‡
   - å®ç°å¤šå› å­é€‰è‚¡
   - æ”¯æŒè‡ªå®šä¹‰ç­›é€‰æ¡ä»¶

## æµ‹è¯•éªŒè¯ / Testing

### æµ‹è¯•1: ä»£ç ä¿®æ”¹éªŒè¯ âœ…
```bash
python test_guided_workflow_fix.py
```

**ç»“æœ**: 
- âœ… æ‰€æœ‰å¿…è¦æ¨¡å—å¯ä»¥å¯¼å…¥
- âœ… ä»£ç å·²ä¿®æ”¹ä¸ºä½¿ç”¨ PerformanceAnalyzer
- âœ… åŒ…å«åå¤‡æ–¹æ¡ˆ
- âœ… æ­£ç¡®ä½¿ç”¨ recommendations å˜é‡

### æµ‹è¯•2: é›†æˆæµ‹è¯•ï¼ˆå¾…å®Œæˆï¼‰
```bash
python main.py
# é€‰æ‹© 0 - å¼•å¯¼å¼å·¥ä½œæµç¨‹
# é€‰æ‹©å¸‚åœºå’Œèµ„äº§ç±»å‹
# æŸ¥çœ‹æ¨èç»“æœ
```

**é¢„æœŸè¡Œä¸º**:
1. æ˜¾ç¤º"æ­£åœ¨åˆ†æ..."
2. æ˜¾ç¤ºè­¦å‘Š"æ— æ³•åˆ†æçœŸå®æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨è"
3. æ˜¾ç¤ºæ¨èåˆ—è¡¨ï¼ˆå½“å‰ä¼šæ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼‰

### æµ‹è¯•3: çœŸå®æ•°æ®æµ‹è¯•ï¼ˆéœ€è¦æ•°æ®æ›´æ–°ï¼‰
æ›´æ–°æ•°æ®åï¼Œåº”è¯¥èƒ½çœ‹åˆ°åŸºäºçœŸå®å†å²æ•°æ®çš„æ¨èã€‚

## ç›¸å…³æ–‡æ¡£ / Related Documentation

- `docs/æ•°æ®å’Œæ¨èè¯´æ˜.md` - è¯¦ç»†çš„é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ
- `docs/éšæœºç§å­è¯´æ˜.md` - éšæœºç§å­ç›¸å…³è¯´æ˜
- `docs/ä½¿ç”¨è¯´æ˜.md` - ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ä»£ç ç¤ºä¾‹ / Code Examples

### ä½¿ç”¨ä¿®æ”¹åçš„å¼•å¯¼å¼å·¥ä½œæµç¨‹

```python
from src.cli.guided_workflow import GuidedWorkflow

# åˆ›å»ºå·¥ä½œæµå®ä¾‹
workflow = GuidedWorkflow(state_dir="./workflow_states")

# å¯åŠ¨å·¥ä½œæµ
workflow.start(resume=True)

# ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
# 1. å°è¯•ä½¿ç”¨çœŸå®æ•°æ®åˆ†æ
# 2. å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
# 3. æ˜¾ç¤ºæ¨èç»“æœ
```

### ç›´æ¥ä½¿ç”¨æ€§èƒ½åˆ†æå™¨

```python
from src.application.performance_analyzer import PerformanceAnalyzer
from src.infrastructure.qlib_wrapper import QlibWrapper
from pathlib import Path

# åˆå§‹åŒ–
qlib_wrapper = QlibWrapper()
qlib_wrapper.init(
    provider_uri=str(Path.home() / ".qlib" / "qlib_data" / "cn_data"),
    region="cn"
)

analyzer = PerformanceAnalyzer(qlib_wrapper)

# åˆ†æï¼ˆéœ€è¦æ•°æ®åœ¨èŒƒå›´å†…ï¼‰
try:
    report = analyzer.analyze_historical_performance(
        market="CN",
        asset_type="stock",
        lookback_years=3,
        instruments="csi300"
    )
    
    # æŸ¥çœ‹æ¨è
    for asset in report.top_performers[:10]:
        print(f"{asset.symbol}: {asset.annual_return*100:.2f}%")
        
except Exception as e:
    print(f"åˆ†æå¤±è´¥: {e}")
```

## æ€»ç»“ / Summary

### å·²å®Œæˆ âœ…
1. ä¿®æ”¹ä»£ç ä½¿ç”¨çœŸå®çš„æ€§èƒ½åˆ†æå™¨
2. æ·»åŠ æ™ºèƒ½åå¤‡æ–¹æ¡ˆ
3. ä¿®å¤å˜é‡å¼•ç”¨é”™è¯¯
4. æ·»åŠ é”™è¯¯å¤„ç†
5. å®‰è£…ç¼ºå¤±ä¾èµ–ï¼ˆscipyï¼‰
6. åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯ä¿®æ”¹

### å½“å‰çŠ¶æ€ âš ï¸
- ä»£ç ä¿®æ”¹å®Œæˆå¹¶éªŒè¯
- ç”±äºæ•°æ®é™åˆ¶ï¼Œå½“å‰ä»ä¼šä½¿ç”¨æ¨¡æ‹Ÿæ¨è
- éœ€è¦æ›´æ–°æ•°æ®æˆ–ä¿®æ”¹æ—¥æœŸèŒƒå›´æ‰èƒ½ä½¿ç”¨çœŸå®åˆ†æ

### ä¸‹ä¸€æ­¥ ğŸ“‹
1. ä¿®æ”¹æ€§èƒ½åˆ†æå™¨æ”¯æŒè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
2. æˆ–æ›´æ–°æ•°æ®åˆ°æœ€æ–°
3. è¿›è¡Œå®Œæ•´çš„é›†æˆæµ‹è¯•

---

**ç»“è®º**: æ¨èåŠŸèƒ½å·²æˆåŠŸä¿®æ”¹ä¸ºä½¿ç”¨çœŸå®æ•°æ®åˆ†æå™¨ï¼Œå¹¶åŒ…å«æ™ºèƒ½åå¤‡æ–¹æ¡ˆã€‚ä¸€æ—¦æ•°æ®æ›´æ–°æˆ–æ—¥æœŸèŒƒå›´è°ƒæ•´ï¼Œå³å¯è·å¾—åŸºäºçœŸå®å†å²æ•°æ®çš„æ¨èã€‚
